# Администрирование Linux. ДЗ №5
## Работа с lvm


## Цель:
> Практика нацелена на получение опыта работы с менеджером логических томов (LVM)

----------------

С чем балуемся: - С `lvm`.

Эта штука по функционалу и гибкости настройки куда более интереснее, чем рассмотренный на прошлой практической работе ***mdadm***.

----------------

Что нужно сделать:
  - Создать файловую систему на логическом томе;
  - Смонтировать её;
  - Создать файл, заполненный нулями на весь размер точки монтирования;
  - Уменьшить файловую систему;
  - Добавить несколько новых файлов и создать снимок;
  - Удалить файлы и после монтирования снимка убедиться, что созданные нами файлы имеются на диске;
  - Сделать слияние томов;
  - Создать ззеркало.

----------------

### Ход работы:
1) Первым делом была развернута виртуальная машина под управленем ubuntu 18.04.5
2) Далее были добавлены в систему 5 виртуальных дисков по 1 Gb каждый.

В этом можно убедиться при помощи рисунка:

![Добавленные носители в систему](https://sun9-53.userapi.com/3FfOWt6msym9ySIaD92dzyHDnOmnszEGrJvzng/9N-LLfnC25c.jpg "Добавленные носители в систему")


3) Установим необходимые пакеты, для этого воспользуемся командой `sudo apt install lvm2 -y`


4) Проверим состояние текущей машины при помощи команд 
```
lsblk
sudo lvmdiskscan
```

Результат выполнения этих команд приведен на рисунке ниже:
![Результат проверки состояния текущей машины](https://sun9-48.userapi.com/jjHGaisR-kuUi2ToVuQU2Xez00AUm8Fz8I_QNw/bDDIL-D8LXw.jpg "Результат проверки состояния текущей машины")

5) Добавим диск, как PV (физический том), для этого воспользуемся последовательностью команд 
```
sudo pvcreate /dev/sdb
sudo pvdisplay
sudo lvmdiskscan
sudo pvs
```

Результат создания физического тома:

![Результат создания физического том](https://sun9-18.userapi.com/QxBpTZVLE-XYwP5hrGoO49GPIg4nrHE3ar3eAA/CZzxuU8IbpM.jpg "Результат создания физического том")

6) Создадим виртуальную группу (VG), для этого воспользуемся командами
```
sudo vgcreate mai /dev/sdb
sudo vgdisplay -v mai
sudo vgs
```

Ниже приведен результат выполнения указанных команд:

![Результат создания виртуальной группы](https://sun9-70.userapi.com/Miwo3n1VC49GuAJ2wuCmnOgcln71GkEPqtG-pA/t-rjXoeeVrw.jpg "Результат создания виртуальной группы")

7) Создадим логический том (LV) при помощи набора команд:
```
sudo lvcreate -l+100%FREE -n first mai
sudo lvdisplay
sudo lvs
```

Ниже приведен результат создания логического тома:

![Результат создания логического тома](https://sun9-73.userapi.com/vvc0lTS4BA71YPzEiTfQ4EE0vWCevXqkxCAOMw/qwRdNQ7_THg.jpg "Результат создания логического тома")


8) Теперь создадим файловую систему, смонтируем ее и проверим:
```
sudo mkfs.ext4 /dev/mai/first
sudo mount /dev/mai/first /mnt
sudo mount
```

Много всего отобразилось, но всё без ошибок:

![Результат создания файловой системе и монтирования ее](https://sun9-56.userapi.com/Y-5le4WC49eRGn7gUAsBBH_k6TIGDTqBaOXuQA/QT-BY-SazzQ.jpg "Результат создания файловой системе и монтирования ее")


9) Теперь создадим файл, который займет всё пространство на лог.томе
```
sudo dd if=/dev/zero of=/mnt/test.file bs=1M count=2000 status=progress
sudo df -h
```

В результате получили следующие записи:

![](https://sun9-53.userapi.com/dJS_vuoCvWuzTSCf1YYr3gFUZwrDL0ZhvrWUWg/qpxjeAnKxlc.jpg "")

10) Произведем расширение логического тома, за счет добавления нового физического диска. Для этого понадобится выполнить команды:
```
sudo pvcreate /dev/sdc
sudo vgextend mai /dev/sdc
sudo lvextend -l+100%FREE /dev/mai/first
sudo lvdisplay
sudo lvs
sudo df -h
```

Вот что получилось в результате выполнения жанных команд:

![Результат добавления нового диска в логический том](https://sun9-45.userapi.com/4QrF0b_56gv2AOV_2SFZ4DZfspu5VabDosZ4sg/M0kMb6GPlbI.jpg "Результат добавления нового диска в логический том")

Всё верно, нужно расширить не только физ.пространство тома, но и файловую систему.

11) Расширим файловую систему, для этого выполним команды:
```
sudo resize2fs /dev/mai/first
sudo df -h
```

Теперь уже есть доступное место, собственно, это и видно из результатов выполнения приведенных команд:

![Результат расширения файловой системы](https://sun9-24.userapi.com/5NBnB9fU4KqD-GBQH9jWx0skPYChhUBYkm1VdA/HyD37AjzF14.jpg "Результат расширения файловой системы")


12) Но вот, живет наш том, никого не трогает, но вот мы понимаем, что нужно срочно выделить дополнительные 500 Мб и мы принимаем решение уменьшить объем файловой системы и самого логического тома. Воспользуемся командами:
```
sudo umount /mnt
sudo fsck -fy /dev/mai/first
sudo resize2fs /dev/mai/first 1100M             sudo resize2fs -M /dev/mai/first
sudo mount /dev/mai/first /mnt
sudo df -h
```

И тут я наткнулся на проблему...

<details>
<summary>Проблема</summary>
  
----------------

![Точка монтирования отсутсвует"](https://sun9-40.userapi.com/N2HNDF0iieS7bnaLCfZGCJ6tHKtyZNxTfNeJ4w/6ZSRmsRm3nk.jpg "Ошибка... Точка монтирования отсутсвует")


Тоже самое получил, когда проделал все вышеописанные шаги уже на другой виртуалке, с новыми дисками, они уже были с фиксированным значением в 1 Gb (а не динамическими)... Собственно:

![Та же проблема на CentOS](https://sun9-52.userapi.com/bnkS05oH-Rw1ZHUUqUbovn9h2QtyUnZIBJ6LMA/-JxVQ4j330E.jpg "Та же проблема на CentOS")


По сути, что происходит: **мы обрезаем так называемый "хвост" файловой системы, потому что она занимает больше места, чем мы ей указали**, это будет видно в тексте ниже.

Решение проблемы ~~выход из положения и разбор причин~~ приведен ниже по тексту.

----------------

</details>

Как от проблемы "обрезки хвоста" избавились? А вот:

Собственно, хоть командой и было указано, что хотим уменьшить размер файловой системы до 1100 Мб - но система нас ~~благополучно проигнорила~~ не послушала, так как посчитала, что ~~достойна большего~~ занимает больше места, и сделала (как видно из рисунка ниже) файловую систему размером в 1,8 Гб.
![После уменьшения размера файловой системы](https://sun9-74.userapi.com/impf/SBF-TVzr1R6Dgqt73H6QeTTHgIMdMK1SUe7QbA/c93JqnP0Qb0.jpg?size=866x793&quality=96&proxy=1&sign=ea132b3eaddc1b2f11d78c5bc5f41775 "После уменьшения размера файловой системы")

Продожим дальше выполнение команд, учитывая то, что у нас файловая система занимает все же 1800 Мб, а не как нам хотелось - 1100 Мб, надо выполнить уменьшение логического тома на такой размер, чтобы не отсечь этой *~~змее~~ файловой системе "хвост"*.

```
sudo umount /mnt
sudo fsck -fy /dev/mai/first
sudo lvreduce /dev/mai/first -L 1810M
sudo fsck -fy /dev/mai/first
sudo mount /dev/mai/first /mnt
sudo df -h
```

Вот результаты:

![Результат уменьшения объема логического тома](https://sun9-76.userapi.com/impf/j2_0rKWGd7gyCNjumbmndOENzcKpkLhUDdQ5Rw/j_qEcO3V9BI.jpg?size=912x848&quality=96&proxy=1&sign=6e1709c1ff0c70ca9222cd42d0d44217 "Результат уменьшения объема логического тома")



------------

На этом лабораторную работу считаю завершенной.

Nikel, 2020
